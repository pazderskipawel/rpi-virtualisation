- name: Wait for Home Assistant API (first boot takes 15-20 min)
  ansible.builtin.uri:
    url: "http://{{ ansible_default_ipv4.address }}:8123/api/onboarding"
    method: GET
    status_code: 200
    timeout: 5
  register: onboarding_check
  until: onboarding_check.status == 200
  retries: 120
  delay: 10

# Desired /api/onboarding response
#[
#  {
#    "step": "user",
#    "done": true
#  },
#  {
#    "step": "core_config",
#    "done": true
#  },
#  {
#    "step": "analytics",
#    "done": true
#  },
#  {
#    "step": "integration",
#    "done": false
#  }
#]

- name: Determine if onboarding is completed (ignoring integration)
  set_fact:
    onboarding_completed: >-
      {{
        onboarding_check.json
        | selectattr('step', '!=', 'integration')
        | map(attribute='done')
        | difference([false])
        | length == (onboarding_check.json | selectattr('step', '!=', 'integration') | list | length)
      }}

- name: Debug onboarding_completed
  debug: var=onboarding_completed

- name: Complete onboarding
  when: not onboarding_completed
  block:

    - name: Create admin user
      ansible.builtin.uri:
        url: "http://{{ ansible_default_ipv4.address }}:8123/api/onboarding/users"
        method: POST
        body_format: json
        body:
          client_id: "http://{{ ansible_default_ipv4.address }}:8123"
          name: "Administrator"
          username: "{{ ha_admin_username }}"
          password: "{{ ha_admin_password }}"
          language: "en"
        status_code: [200, 400]
      register: user_created

    - name: Save auth code
      ansible.builtin.set_fact:
        ha_auth_code: "{{ user_created.json.auth_code | default('') }}"
      when: 
        - user_created.status is defined
        - user_created.status == 200

    - name: Exchange auth code for access token
      ansible.builtin.uri:
        url: "http://{{ ansible_default_ipv4.address }}:8123/auth/token"
        method: POST
        body_format: form-urlencoded
        body:
          grant_type: "authorization_code"
          code: "{{ ha_auth_code }}"
          client_id: "http://{{ ansible_default_ipv4.address }}:8123"
        status_code: [200]
      register: token_response
      when: ha_auth_code is defined and ha_auth_code != ''

    - name: Save access token
      ansible.builtin.set_fact:
        ha_auth_token: "{{ token_response.json.access_token }}"
      when: 
        - token_response is defined
        - token_response.status == 200
        - token_response.json.access_token is defined

    - name: Set location and unit system
      ansible.builtin.uri:
        url: "http://{{ ansible_default_ipv4.address }}:8123/api/onboarding/core_config"
        method: POST
        body_format: json
        body:
          latitude: 53.1235
          longitude: 18.0076
          elevation: 60
          unit_system: metric
          time_zone: "Europe/Warsaw"
          currency: "PLN"
          country: "PL"
        headers:
          Authorization: "Bearer {{ ha_auth_token }}"
        status_code: [200, 400]
      when: ha_auth_token is defined and ha_auth_token != ''

    - name: Complete onboarding - integration
      ansible.builtin.uri:
        url: "http://{{ ansible_default_ipv4.address }}:8123/api/onboarding/integration"
        method: POST
        body_format: json
        body: {}
        headers:
          Authorization: "Bearer {{ ha_auth_token }}"
        status_code: [200, 400]
      when: ha_auth_token is defined and ha_auth_token != ''

    - name: Disable analytics
      ansible.builtin.uri:
        url: "http://{{ ansible_default_ipv4.address }}:8123/api/onboarding/analytics"
        method: POST
        body_format: json
        body:
          preferences:
            base: false
            usage: false
            statistics: false
            diagnostics: false
        headers:
          Authorization: "Bearer {{ ha_auth_token }}"
        status_code: [200, 400]
      when: ha_auth_token is defined and ha_auth_token != ''
