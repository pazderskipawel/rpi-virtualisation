- name: Ensure directory exists
  ansible.builtin.file:
    path: /home/rpi/files/nginx
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0755'

- name: Start nginx container
  community.docker.docker_container:
    name: nginx
    image: nginx:latest
    state: started
    restart_policy: unless-stopped
    network_mode: host
    volumes:
      - /home/rpi/files/nginx:/etc/nginx/conf.d:ro

- name: Verify nginx container is running
  community.docker.docker_container_info:
    name: nginx
  register: nginx_info
  retries: 5
  delay: 2
  until: nginx_info.container.State.Running
  failed_when: not nginx_info.container.State.Running

- name: Allow HTTP through firewall
  community.general.ufw:
    rule: allow
    port: 8080
    proto: tcp
    comment: 'nginx HTTP'