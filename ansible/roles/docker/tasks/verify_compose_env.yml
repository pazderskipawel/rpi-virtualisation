- name: Verify {{ service_name }} compose project
  community.docker.docker_compose_v2:
    project_src: "{{ service_dir }}"
    state: present
  register: compose_status

- name: Assert all services healthy
  assert:
    that:
      - compose_status.services is defined
      - compose_status.services | length > 0
    fail_msg: "No services found in {{ service_dir }}"

- name: Check containers have Traefik labels
  community.docker.docker_container_info:
    name: "{{ item.name }}"
  loop: "{{ compose_status.services }}"
  register: container_checks
  when: traefik_enabled | default(false)

- name: Assert Traefik integration
  assert:
    that:
      - "'traefik.enable' in item.container.Config.Labels"
      - "'proxy' in (item.container.NetworkSettings.Networks | default({}))"
  loop: "{{ container_checks.results }}"
  when: traefik_enabled | default(false)
