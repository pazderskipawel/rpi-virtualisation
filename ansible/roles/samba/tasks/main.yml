- name: Install Samba
  apt:
    name: samba
    state: present
    update_cache: yes

- name: Create Samba config directory
  file:
    path: /etc/samba
    state: directory
    mode: '0755'

- name: Copy base Samba configuration
  copy:
    src: "{{ role_path }}/files/smb.conf"
    dest: /etc/samba/smb.conf
    mode: '0644'
  notify: Restart samba service

- name: Check if Samba user exists
  shell: pdbedit -L | grep -q "^{{ ansible_user }}:"
  register: samba_user_exists
  failed_when: false
  changed_when: false
  become: yes

- name: Add ansible user to Samba
  shell: |
    smbpasswd -a -s {{ ansible_user }}
  when: samba_user_exists.rc != 0
  become: yes

- name: Enable and start Samba service
  systemd:
    name: smbd
    enabled: yes
    state: started

- name: Allow smb through firewall
  community.general.ufw:
    rule: allow
    port: 455
    proto: tcp
    comment: 'samba'
