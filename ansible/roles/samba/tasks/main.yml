- name: Create directory
  ansible.builtin.file:
    path: "/home/rpi/files/samba"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    state: directory
    mode: '0755'

- name: Copy smb config to opt directory
  ansible.builtin.copy:
    src: "{{ role_path }}/files/smb.conf"
    dest: "/home/rpi/files/samba/smb.conf"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0644'

- name: Create and start Samba container
  community.docker.docker_container:
    name: samba
    image: dockurr/samba
    state: started
    restart_policy: unless-stopped
    ports:
      - "445:445"
    volumes:
      - "/home/files:/files"
    env:
      USER: "{{ samba_user_name }}"
      PASS: "{{ samba_user_password }}"
    command: >
      sh -c "ln -sf /files/samba/smb.conf /etc/samba/smb.conf && 
             exec smbd --foreground --no-process-group"

- name: Allow smb through firewall
  community.general.ufw:
    rule: allow
    port: 455
    proto: tcp
    comment: 'samba'
