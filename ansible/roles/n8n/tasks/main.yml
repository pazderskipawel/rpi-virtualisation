- name: Create n8n directories
  file:
    path: "{{ n8n_files_path }}"
    state: directory
    mode: '0755'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Start n8n container
  community.docker.docker_container:
    name: "n8n"
    image: "n8nio/n8n:latest"
    state: started
    restart_policy: "unless-stopped"
    volumes:
      - "{{ n8n_files_path }}:/home/node/.n8n"
      - "{{ n8n_repo_path }}:/tmp/repo"
    network_mode: host
    env:
      N8N_SECURE_COOKIE: "false"
      N8N_HOST: "{{ ansible_default_ipv4.address }}"
      N8N_PORT: "{{ n8n_port }}"
      N8N_PROTOCOL: "http"
      WEBHOOK_URL: "http://{{ ansible_default_ipv4.address }}:{{ n8n_port }}/"
      
- name: Open n8n port on UFW
  community.general.ufw:
    rule: allow
    port: "{{ n8n_port }}"
    proto: tcp

- name: Verify n8n localhost health
  uri:
    url: "http://localhost:{{ n8n_port }}/"
    method: GET
    status_code: 200
  retries: 5
  delay: 5
  register: n8n_health

- name: Display n8n localhost status
  debug:
    msg: "n8n is running and healthy at http://localhost:{{ n8n_port }}"
  when: n8n_health is succeeded

- name: Setup user for n8n
  include_tasks: setup_n8n.yml

- name: Add Samba share
  include_role: 
    name: samba
    tasks_from: add_samba_share
  vars:
    share_name: n8n
    share_path: "{{ n8n_repo_path }}"
    share_service_name: n8n-workflows