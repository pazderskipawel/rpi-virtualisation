- name: Add n8n config to nginx
  include_tasks: ../nginx/tasks/add_service.yml
  vars:
    service_name: n8n
    service_config_path: "{{ n8n_nginx_path }}"

- name: Create n8n data directory
  file:
    path: "{{ n8n_files_path }}"
    state: directory
    mode: '0755'

- name: Start n8n container
  community.docker.docker_container:
    name: "n8n"
    image: "n8nio/n8n:latest"
    state: started
    restart_policy: "unless-stopped"
    ports:
      - "127.0.0.1:{{ n8n_port }}:5678"
    volumes:
      - "{{ n8n_files_path }}:/home/node/.n8n"
    network_mode: host
    user: "1000:1000"

- name: Open n8n port on UFW
  community.general.ufw:
    rule: allow
    port: "{{ n8n_port }}"
    proto: tcp

- name: Verify n8n localhost health
  uri:
    url: "http://localhost:{{ n8n_port }}/api/v1/health"
    method: GET
    status_code: 200
  retries: 5
  delay: 5
  register: n8n_health

- name: Display n8n localhost status
  debug:
    msg: "n8n is running and healthy at http://localhost:{{ n8n_port }}"
  when: n8n_health is succeeded

- name: Verify n8n proxy health
  uri:
    url: "http://{{ ansible_default_ipv4.address }}:{{ n8n_port }}/api/v1/health"
    method: GET
    status_code: 200
  retries: 5
  delay: 5
  register: n8n_proxy_health

- name: Display n8n proxy status
  debug:
    msg: "n8n is running and healthy at http://{{ ansible_default_ipv4.address }}:{{ n8n_port }}"
  when: n8n_proxy_health is succeeded
