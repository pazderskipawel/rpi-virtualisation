- name: Remove all docker resources and VMs
  hosts: localhost
  become: true
  vars:
    vms_to_remove:
      - haos
    vm_networks_to_remove:
      - haos_net
    containers_to_remove:
      - nginx
      - klipper
      - moonraker
      - fluidd
      - samba
      - vpn
      
  tasks:
    - name: Stop and destroy VMs
      community.libvirt.virt:
        name: "{{ item }}"
        state: destroyed
      loop: "{{ vms_to_remove }}"
      ignore_errors: yes

    - name: Undefine VMs with storage removal
      ansible.builtin.command:
        cmd: "virsh undefine {{ item }} --remove-all-storage --nvram"
      loop: "{{ vms_to_remove }}"
      ignore_errors: yes

    - name: Stop networks
      ansible.builtin.command:
        cmd: "virsh net-destroy {{ item }}"
      loop: "{{ vm_networks_to_remove }}"
      ignore_errors: yes

    - name: Undefine networks
      ansible.builtin.command:
        cmd: "virsh net-undefine {{ item }}"
      loop: "{{ vm_networks_to_remove }}"
      ignore_errors: yes

    - name: Remove VM image directories
      ansible.builtin.file:
        path: "/var/lib/libvirt/images/{{ item }}"
        state: absent
      loop: "{{ vms_to_remove }}"
      ignore_errors: yes

    - name: Remove containers
      ansible.builtin.command:
        cmd: "docker rm -f {{ item }}"
      loop: "{{ containers_to_remove }}"
      ignore_errors: yes

    - name: Remove nginx configs
      ansible.builtin.file:
        path: /home/rpi/files/nginx
        state: absent
    
    - name: Remove klipper configs
      ansible.builtin.file:
        path: /home/rpi/files/printer_data
        state: absent
    
    - name: remove wireguard configs
      ansible.builtin.file:
        path: /home/rpi/files/wireguard
        state: absent

    - name: remove samba configs
      ansible.builtin.file:
        path: /home/rpi/files/samba
        state: absent
